<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tootronome</title>
<style>
  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #222; color: white; }
  .card { background: #333; padding: 20px; border-radius: 12px; text-align: center; max-width: 300px; }
  input[type=range] { width: 100%; }
  label { display: block; margin-top: 10px; }
  .fart-buttons { display: flex; gap: 6px; justify-content: center; margin-top: 10px; }
  .fart-buttons button { flex: 1; padding: 5px; border-radius: 6px; border: none; background: #555; color: white; cursor: pointer; }
  .fart-buttons button.active { background: #0a84ff; }
</style>
</head>
<body>
<div class="card">
  <h1>ðŸ’¨ Tootronome</h1>

  <label>FPM: <span id="bpmDisplay">100</span>
    <input id="bpm" type="range" min="20" max="300" value="100">
  </label>

  <label>Volume:
    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
  </label>

  <div class="fart-buttons">
    <button data-file="fart.mp3" class="active">Fart 1</button>
    <button data-file="fart2.mp3">Fart 2</button>
    <button data-file="fart3.mp3">Fart 3</button>
  </div>

  <button id="toggle">Start</button>
</div>

<script>
(() => {
  const bpmSlider = document.getElementById('bpm');
  const bpmDisplay = document.getElementById('bpmDisplay');
  const volumeSlider = document.getElementById('volume');
  const toggleBtn = document.getElementById('toggle');
  const fartButtons = document.querySelectorAll('.fart-buttons button');

  let audioCtx = null;
  let fartBuffer = null;
  let fartFile = "fart.mp3";
  let isRunning = false;
  let currentBeatTime = 0;
  const lookahead = 25; // ms
  const scheduleAheadTime = 0.1; // sec

  bpmSlider.addEventListener('input', () => {
    bpmDisplay.textContent = bpmSlider.value;
  });

  async function loadFartSound(file) {
    const resp = await fetch(file);
    const arrayBuffer = await resp.arrayBuffer();
    fartBuffer = await audioCtx.decodeAudioData(arrayBuffer);
  }

  function playFart(time) {
    const source = audioCtx.createBufferSource();
    source.buffer = fartBuffer;
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = parseFloat(volumeSlider.value);
    source.connect(gainNode).connect(audioCtx.destination);
    source.start(time);
  }

  function nextBeatInterval() {
    return 60.0 / parseInt(bpmSlider.value, 10);
  }

  function scheduler() {
    while (currentBeatTime < audioCtx.currentTime + scheduleAheadTime) {
      playFart(currentBeatTime);
      currentBeatTime += nextBeatInterval();
    }
    if (isRunning) {
      setTimeout(scheduler, lookahead);
    }
  }

  fartButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      fartFile = btn.dataset.file;
      fartButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (audioCtx) {
        await loadFartSound(fartFile);
      }
    });
  });

  toggleBtn.addEventListener('click', async () => {
    if (!isRunning) {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await loadFartSound(fartFile);
      }
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      isRunning = true;
      toggleBtn.textContent = "Stop";
      currentBeatTime = audioCtx.currentTime + 0.05;
      scheduler();
    } else {
      isRunning = false;
      toggleBtn.textContent = "Start";
    }
  });
})();
</script>
</body>
</html>
