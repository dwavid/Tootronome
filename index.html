<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fart Metronome</title>
<style>
  :root { --bg:#0f1115; --fg:#e8e8ea; --muted:#9aa0a6; --acc:#7cf47c; --accent:#7cf47c33; }
  * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background:radial-gradient(1200px 1200px at 80% -10%, var(--accent), transparent) , var(--bg); color:var(--fg); display:grid; place-items:center; min-height:100svh; }
  .card { width:min(680px, 92vw); background:#161a22; border:1px solid #222836; border-radius:16px; padding:22px 20px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  h1 { margin:0 0 12px; font-size:1.25rem; display:flex; gap:.5ch; align-items:center; }
  h1 span { font-size:1rem; color:var(--muted); font-weight:500; }
  .controls { display:grid; grid-template-columns:1fr auto; gap:14px; align-items:center; }
  .row { display:grid; grid-template-columns:1fr 100px; gap:12px; align-items:center; }
  label { font-size:.95rem; color:var(--muted); }
  input[type="range"] { width:100%; }
  input[type="number"] {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #273043; background:#12161f; color:var(--fg);
    font-size:1rem; -moz-appearance:textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  button {
    border:0; padding:12px 16px; border-radius:12px; background:linear-gradient(180deg, #21d07a, #09b85f);
    color:#062c1c; font-weight:700; cursor:pointer; transition:transform .05s ease, filter .15s ease; min-width:120px;
  }
  button[aria-pressed="true"] { background:linear-gradient(180deg,#ef5a5a,#da3d3d); color:#2d0505; }
  button:active { transform:translateY(1px); }
  .meter {
    margin-top:16px; height:14px; background:#0f1320; border:1px solid #222836; border-radius:999px; overflow:hidden; position:relative;
  }
  .pulse { position:absolute; inset:0; width:0%; background: linear-gradient(90deg, var(--acc), transparent 60%); opacity:.9; }
  .beats { margin-top:14px; display:flex; gap:8px; }
  .dot {
    width:14px; height:14px; border-radius:50%; background:#25304a; border:1px solid #2e3a58; opacity:.8; transition:transform .06s ease, background .12s ease, opacity .12s ease;
  }
  .dot.on { background:#7cf47c; opacity:1; transform:scale(1.2); }
  .subtle { font-size:.9rem; color:var(--muted); margin-top:12px; }
  .vol { display:grid; grid-template-columns:1fr 80px; gap:12px; align-items:center; margin-top:10px; }
</style>
</head>
<body>
  <div class="card">
    <h1>ðŸ’¨ Fart Metronome <span>(cartoon noise every beat)</span></h1>

    <div class="controls">
      <div class="row">
        <label for="bpmRange">Farts per minute (BPM)</label>
        <input id="bpmNumber" type="number" min="20" max="300" value="100" step="1" />
      </div>
      <button id="toggle" aria-pressed="false">Start</button>
    </div>

    <input id="bpmRange" type="range" min="20" max="300" value="100" step="1" aria-label="BPM slider" />

    <div class="vol">
      <label for="volume">Volume</label>
      <input id="volume" type="range" min="0" max="1" value="0.8" step="0.01" />
    </div>

    <div class="meter" aria-hidden="true"><div class="pulse" id="pulse"></div></div>
    <div class="beats" id="beats" aria-hidden="true"></div>

    <div class="subtle">Tip: Use number input or slider to set tempo. Start/Stop toggles the metronome. Works offline.</div>
  </div>

<script>
(() => {
  // --- UI elements ---
  const bpmRange = document.getElementById('bpmRange');
  const bpmNumber = document.getElementById('bpmNumber');
  const volume = document.getElementById('volume');
  const toggleBtn = document.getElementById('toggle');
  const pulse = document.getElementById('pulse');
  const beatsWrap = document.getElementById('beats');

  // Visual beat dots (4-beat cycle just for looks)
  const dots = Array.from({ length: 4 }, () => {
    const d = document.createElement('div');
    d.className = 'dot';
    beatsWrap.appendChild(d);
    return d;
  });

  // --- Audio setup ---
  let audioCtx = null;
  let masterGain = null;

  const ensureAudio = () => {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = parseFloat(volume.value);
      masterGain.connect(audioCtx.destination);
    }
    if (audioCtx.state === "suspended") audioCtx.resume();
  };

  // Make a brief, silly "fart" using filtered noise + sub osc + envelopes.
  function scheduleFart(when) {
    if (!audioCtx) return;

    const endTime = when + 0.25 + Math.random() * 0.05; // 250â€“300ms

    // Noise source
    const bufferSize = Math.floor(audioCtx.sampleRate * 0.35);
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = noiseBuffer.getChannelData(0);
    // Pink-ish / brown-ish noise blend for a softer "pfft"
    let lastOut = 0.0;
    for (let i = 0; i < bufferSize; i++) {
      const white = Math.random() * 2 - 1;
      // simple brown-ish filter
      const brown = (lastOut + 0.02 * white) / 1.02;
      lastOut = brown;
      data[i] = (white * 0.2 + brown * 0.8) * (0.8 + Math.random()*0.2);
    }
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;
    noise.loop = false;

    // Filter & envelope
    const filter = audioCtx.createBiquadFilter();
    filter.type = "lowpass";
    filter.Q.value = 7;

    // Sub oscillator to add a comedic "blat"
    const osc = audioCtx.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(80 + Math.random()*20, when); // 80â€“100 Hz
    osc.frequency.exponentialRampToValueAtTime(50 + Math.random()*10, endTime);

    // Gain envelopes
    const noiseGain = audioCtx.createGain();
    const oscGain = audioCtx.createGain();
    const outGain = audioCtx.createGain();

    // Envelope shapes
    const nStart = when;
    const oStart = when;
    const nPeak = 0.9, oPeak = 0.4;

    noiseGain.gain.setValueAtTime(0.0001, nStart);
    noiseGain.gain.exponentialRampToValueAtTime(nPeak, nStart + 0.01);
    noiseGain.gain.exponentialRampToValueAtTime(0.0001, endTime);

    oscGain.gain.setValueAtTime(0.0001, oStart);
    oscGain.gain.exponentialRampToValueAtTime(oPeak, oStart + 0.015);
    oscGain.gain.exponentialRampToValueAtTime(0.0001, endTime);

    // Filter sweep (gives that fluttery release)
    filter.frequency.setValueAtTime(900 + Math.random()*400, when);
    filter.frequency.exponentialRampToValueAtTime(250 + Math.random()*80, endTime);

    // Routing
    noise.connect(filter);
    filter.connect(noiseGain);
    osc.connect(oscGain);

    // Slight stereo spread for fun
    const merger = audioCtx.createChannelMerger(2);
    const panL = audioCtx.createGain(), panR = audioCtx.createGain();
    noiseGain.connect(panL);
    oscGain.connect(panR);
    panL.connect(merger, 0, 0);
    panR.connect(merger, 0, 1);

    merger.connect(outGain);
    outGain.connect(masterGain);

    // Schedule
    noise.start(when);
    osc.start(when);
    noise.stop(endTime + 0.02);
    osc.stop(endTime + 0.02);
  }

  // --- Metronome scheduler (Web Audioâ€“friendly) ---
  let isRunning = false;
  let currentBeat = 0;
  let nextNoteTime = 0;
  const lookahead = 25;           // ms
  const scheduleAheadTime = 0.1;  // seconds

  function nextBeatInterval() {
    const bpm = clampBpm(getBpm());
    return 60.0 / bpm;
  }

  function scheduler() {
    if (!isRunning || !audioCtx) return;
    while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
      scheduleFart(nextNoteTime);
      animateBeat(nextNoteTime);
      nextNoteTime += nextBeatInterval();
      currentBeat = (currentBeat + 1) % 4;
    }
    setTimeout(scheduler, lookahead);
  }

  // --- UI helpers ---
  function clampBpm(v) {
    return Math.min(300, Math.max(20, v|0));
  }
  function setBpm(v) {
    const val = clampBpm(v);
    bpmRange.value = String(val);
    bpmNumber.value = String(val);
  }
  function getBpm() {
    return parseInt(bpmNumber.value, 10) || 100;
  }

  function animateBeat(atTime) {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    const delay = Math.max(0, (atTime - now) * 1000);
    const beatIndex = currentBeat; // capture

    // Pulse bar
    setTimeout(() => {
      pulse.style.transition = 'none';
      pulse.style.width = '0%';
      // allow style to apply before expanding
      requestAnimationFrame(() => {
        pulse.style.transition = 'width 160ms ease-out';
        pulse.style.width = '100%';
      });

      // Dots
      dots.forEach((d, i) => d.classList.toggle('on', i === beatIndex));
    }, delay);
  }

  // Start/Stop
  toggleBtn.addEventListener('click', async () => {
    ensureAudio();
    if (!isRunning) {
      isRunning = true;
      toggleBtn.textContent = 'Stop';
      toggleBtn.setAttribute('aria-pressed', 'true');
      // restart timeline on start to avoid drift
      nextNoteTime = audioCtx.currentTime + 0.05;
      scheduler();
    } else {
      isRunning = false;
      toggleBtn.textContent = 'Start';
      toggleBtn.setAttribute('aria-pressed', 'false');
      dots.forEach(d => d.classList.remove('on'));
      pulse.style.width = '0%';
    }
  });

  // BPM controls stay in sync & are live while running
  bpmRange.addEventListener('input', e => setBpm(e.target.value));
  bpmNumber.addEventListener('input', e => setBpm(e.target.value));

  // Smoothly handle tempo changes mid-run by shifting nextNoteTime so the *next* beat uses new tempo.
  [bpmRange, bpmNumber].forEach(el => {
    el.addEventListener('change', () => {
      if (audioCtx && isRunning) {
        // Align nextNoteTime to current time to adopt new tempo immediately after the next beat
        const t = audioCtx.currentTime;
        if (nextNoteTime - t > 0.3) nextNoteTime = t + 0.05;
      }
    });
  });

  // Volume
  volume.addEventListener('input', () => {
    ensureAudio();
    masterGain.gain.setTargetAtTime(parseFloat(volume.value), audioCtx.currentTime, 0.01);
  });

  // Initialize fields
  setBpm(100);
})();
</script>
</body>
</html>
