<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tootronome</title>
<style>
  body { 
    font-family: sans-serif; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    background: #222; 
    color: white; 
  }
  .card { 
    background: #333; 
    padding: 20px; 
    border-radius: 12px; 
    text-align: center; 
    max-width: 300px; 
  }
  input[type=range] { width: 100%; }
  label { display: block; margin-top: 10px; }
  .fart-buttons { margin-top: 15px; }
  .fart-buttons button {
    background: #444;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    margin: 3px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .fart-buttons button:hover {
    background: #666;
  }
  #toggle {
    display: block;
    width: 100%;
    padding: 12px;
    margin-top: 20px;
    border: none;
    border-radius: 8px;
    background: #28a745;
    color: white;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }
  #toggle:hover {
    background: #218838;
  }
  #toggle.stop {
    background: #dc3545;
  }
  #toggle.stop:hover {
    background: #b02a37;
  }
</style>
</head>
<body>
<div class="card">
  <h1>ðŸ’¨ Tootronome</h1>

  <label>FPM: <span id="bpmDisplay">60</span>
    <input id="bpm" type="range" min="20" max="300" value="60">
  </label>

  <label>Volume:
    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
  </label>

  <div class="fart-buttons">
    <button data-sound="fart.mp3">Fart 1</button>
    <button data-sound="fart2.mp3">Fart 2</button>
    <button data-sound="fart3.mp3">Fart 3</button>
  </div>

  <button id="toggle">Start</button>
</div>

<script>
(() => {
  const bpmSlider = document.getElementById('bpm');
  const bpmDisplay = document.getElementById('bpmDisplay');
  const volumeSlider = document.getElementById('volume');
  const toggleBtn = document.getElementById('toggle');
  const fartButtons = document.querySelectorAll('.fart-buttons button');

  let audioCtx = null;
  let fartBuffer = null;
  let isRunning = false;
  let currentBeatTime = 0;
  let currentFartFile = "fart.mp3";
  const lookahead = 25; // ms
  const scheduleAheadTime = 0.1; // sec

  bpmSlider.addEventListener('input', () => {
    bpmDisplay.textContent = bpmSlider.value;
  });

  fartButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      currentFartFile = btn.dataset.sound;
      if (audioCtx) {
        await loadFartSound();
      }
    });
  });

  async function loadFartSound() {
    const resp = await fetch(currentFartFile);
    const arrayBuffer = await resp.arrayBuffer();
    fartBuffer = await audioCtx.decodeAudioData(arrayBuffer);
  }

  function playFart(time) {
    const source = audioCtx.createBufferSource();
    source.buffer = fartBuffer;
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = parseFloat(volumeSlider.value);
    source.connect(gainNode).connect(audioCtx.destination);
    source.start(time);
  }

  function nextBeatInterval() {
    return 60.0 / parseInt(bpmSlider.value, 10);
  }

  function scheduler() {
    while (currentBeatTime < audioCtx.currentTime + scheduleAheadTime) {
      playFart(currentBeatTime);
      currentBeatTime += nextBeatInterval();
    }
    if (isRunning) {
      setTimeout(scheduler, lookahead);
    }
  }

  toggleBtn.addEventListener('click', async () => {
    if (!isRunning) {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await loadFartSound();
      }
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      isRunning = true;
      toggleBtn.textContent = "Stop";
      toggleBtn.classList.add("stop");
      currentBeatTime = audioCtx.currentTime + 0.05;
      scheduler();
    } else {
      isRunning = false;
      toggleBtn.textContent = "Start";
      toggleBtn.classList.remove("stop");
    }
  });
})();
</script>
</body>
</html>
